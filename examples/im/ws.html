<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>v-connect-im WebSocket Tester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      margin: 20px;
    }

    h1 {
      font-size: 20px;
    }

    .row {
      margin: 8px 0;
    }

    input,
    select,
    button,
    textarea {
      font-size: 14px;
      padding: 6px;
    }

    textarea {
      width: 100%;
      height: 220px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .label {
      display: inline-block;
      min-width: 120px;
    }

    .ok {
      color: #0a7;
    }

    .err {
      color: #c00;
    }
  </style>
</head>

<body>
  <!-- WebSocket测试页面 / WebSocket testing page -->
  <h1>v-connect-im WebSocket 测试 / WebSocket Test</h1>

  <div class="grid">
    <div>
      <div class="row"><span class="label">Host:</span><input id="host" value="127.0.0.1" /></div>
      <div class="row"><span class="label">WS Port:</span><input id="port" value="5200" /></div>
      <div class="row"><span class="label">UID:</span><input id="uid" value="uA" /></div>
      <div class="row"><span class="label">Token:</span><input id="token" value="token" /></div>
      <div class="row"><button id="btnConnect">连接 / Connect</button> <button id="btnClose">关闭 / Close</button></div>
      <div class="row"><button id="btnPing">心跳 / Ping</button> <button id="btnOnline">在线列表 / Online Clients</button>
      </div>
    </div>
    <div>
      <div class="row"><span class="label">目标UID / Target UID:</span><input id="targetUid" value="uB" /></div>
      <div class="row"><span class="label">消息内容 / Message JSON:</span></div>
      <textarea id="messageJson">{"text": "Hello"}</textarea>
      <div class="row"><button id="btnAuth">鉴权 / Auth</button> <button id="btnSend">发送 / Send</button></div>
    </div>
  </div>

  <div class="row"><span class="label">状态 / Status:</span><span id="status">未连接 / Disconnected</span></div>
  <div class="row"><span class="label">日志 / Logs:</span></div>
  <textarea id="logs" readonly></textarea>

  <script>
    // 简易日志函数 / Simple logging helper
    const log = (msg, cls) => {
      const el = document.getElementById('logs');
      el.value += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
      if (cls) document.getElementById('status').className = cls;
    };

    let ws = null;

    const url = () => `ws://${document.getElementById('host').value}:${document.getElementById('port').value}`;

    // 连接到WS服务器 / Connect to WebSocket server
    document.getElementById('btnConnect').onclick = () => {
      try {
        if (ws && ws.readyState !== WebSocket.CLOSED) { try { ws.close(); } catch { } ws = null; }
        ws = new WebSocket(url());
        document.getElementById('status').textContent = '连接中 / Connecting...';
        ws.onopen = () => {
          document.getElementById('status').textContent = '已连接 / Connected';
          document.getElementById('status').className = 'ok';
          log(`WS OPEN ${url()}`);
          // 自动鉴权与心跳 / Auto auth and ping
          const uid = document.getElementById('uid').value;
          const token = document.getElementById('token').value;
          ws.send(JSON.stringify({ type: 'auth', data: { uid, token } }));
          ws.send(JSON.stringify({ type: 'ping', data: {} }));
        };
        ws.onclose = (ev) => { document.getElementById('status').textContent = `关闭(${ev.code}) / Closed`; document.getElementById('status').className = 'err'; log(`WS CLOSE code=${ev.code} reason=${ev.reason}`); };
        ws.onerror = (ev) => { document.getElementById('status').textContent = '错误 / Error'; document.getElementById('status').className = 'err'; log(`WS ERROR ${ev.message || ev}`); };
        ws.onmessage = (ev) => { log(`WS MESSAGE: ${ev.data}`); };
      } catch (e) {
        log(`连接失败 / Connect failed: ${e}`, 'err');
      }
    };

    // 关闭连接 / Close connection
    document.getElementById('btnClose').onclick = () => { if (ws) { try { ws.close(); } catch { } ws = null; } };

    // 发送Ping / Send ping
    document.getElementById('btnPing').onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return log('未连接 / Not connected', 'err');
      ws.send(JSON.stringify({ type: 'ping', data: {} }));
      log('发送 ping / Send ping');
    };

    // 获取在线列表 / Get online clients
    document.getElementById('btnOnline').onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return log('未连接 / Not connected', 'err');
      ws.send(JSON.stringify({ type: 'online_clients', data: {} }));
      log('请求在线列表 / Request online clients');
    };

    // 鉴权 / Auth
    document.getElementById('btnAuth').onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return log('未连接 / Not connected', 'err');
      const uid = document.getElementById('uid').value;
      const token = document.getElementById('token').value;
      ws.send(JSON.stringify({ type: 'auth', data: { uid, token } }));
      log(`发送鉴权 / Send auth uid=${uid}`);
    };

    // 发送消息到目标UID / Send message to target UID
    document.getElementById('btnSend').onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return log('未连接 / Not connected', 'err');
      const targetUid = document.getElementById('targetUid').value;
      let content = {};
      try { content = JSON.parse(document.getElementById('messageJson').value || '{}'); } catch (e) { return log('消息JSON不合法 / Invalid message JSON', 'err'); }
      const msg = { type: 'message', data: content, target_uid: targetUid };
      ws.send(JSON.stringify(msg));
      log(`发送消息到 ${targetUid} / Send message to ${targetUid}`);
    };
  </script>
</body>

</html>