# æ‰‹åŠ¨æž„å»ºå·¥ä½œæµ / Manual Build Workflow
#
# æ­¤å·¥ä½œæµå…è®¸æ‰‹åŠ¨è§¦å‘æž„å»ºï¼Œå¯ä»¥è‡ªå®šä¹‰æž„å»ºå‚æ•°
# This workflow allows manual triggering with customizable build parameters

name: Manual Build

on:
    workflow_dispatch:
        inputs:
            component:
                description: "é€‰æ‹©è¦æž„å»ºçš„ç»„ä»¶ / Select component to build"
                required: true
                type: choice
                options:
                    - all
                    - v-connect-im
                    - plugins
            platform:
                description: "é€‰æ‹©ç›®æ ‡å¹³å° / Select target platform"
                required: true
                type: choice
                options:
                    - all
                    - linux-amd64
                    - linux-arm64
                    - darwin-amd64
                    - darwin-arm64
            build_type:
                description: "æž„å»ºç±»åž‹ / Build type"
                required: true
                type: choice
                default: "release"
                options:
                    - release
                    - debug
            create_release:
                description: "åˆ›å»º GitHub Release / Create GitHub Release"
                required: false
                type: boolean
                default: false

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    build:
        name: æ‰‹åŠ¨æž„å»º / Manual Build
        runs-on: ${{ matrix.runner }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: linux
                      arch: amd64
                      runner: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      enabled: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux-amd64' }}

                    - os: linux
                      arch: arm64
                      runner: ubuntu-latest
                      target: aarch64-unknown-linux-gnu
                      enabled: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux-arm64' }}

                    - os: darwin
                      arch: amd64
                      runner: macos-13
                      target: x86_64-apple-darwin
                      enabled: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'darwin-amd64' }}

                    - os: darwin
                      arch: arm64
                      runner: macos-14
                      target: aarch64-apple-darwin
                      enabled: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'darwin-arm64' }}

        # åªè¿è¡Œå¯ç”¨çš„å¹³å° / Only run enabled platforms
        if: matrix.enabled == 'true'

        steps:
            - name: æ£€å‡ºä»£ç  / Checkout code
              uses: actions/checkout@v4

            - name: å®‰è£… Rust å·¥å…·é“¾ / Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…· (Linux ARM64) / Install cross-compilation tools (Linux ARM64)
              if: matrix.os == 'linux' && matrix.arch == 'arm64'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

            - name: ç¼“å­˜ Cargo ä¾èµ– / Cache Cargo dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-${{ matrix.arch }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.arch }}-cargo-

            - name: æž„å»º v-connect-im / Build v-connect-im
              if: github.event.inputs.component == 'all' || github.event.inputs.component == 'v-connect-im'
              run: |
                  if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
                    cargo build --release --package v-connect-im --target ${{ matrix.target }}
                  else
                    cargo build --package v-connect-im --target ${{ matrix.target }}
                  fi

            - name: æž„å»ºæ’ä»¶ / Build plugins
              if: github.event.inputs.component == 'all' || github.event.inputs.component == 'plugins'
              run: |
                  if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
                    cargo build --release --package v-connect-im-plugin-storage-sled --target ${{ matrix.target }}
                    cargo build --release --package v-connect-im-plugin-gateway --target ${{ matrix.target }}
                  else
                    cargo build --package v-connect-im-plugin-storage-sled --target ${{ matrix.target }}
                    cargo build --package v-connect-im-plugin-gateway --target ${{ matrix.target }}
                  fi

            - name: æ‰“åŒ…äº§ç‰© / Package artifacts
              run: |
                  BUILD_TYPE="${{ github.event.inputs.build_type }}"
                  OUTPUT_DIR="dist/manual-build-${{ matrix.os }}-${{ matrix.arch }}"
                  mkdir -p "$OUTPUT_DIR"

                  # ç¡®å®šäºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ / Determine binary path
                  if [ "$BUILD_TYPE" = "release" ]; then
                    BIN_PATH="target/${{ matrix.target }}/release"
                  else
                    BIN_PATH="target/${{ matrix.target }}/debug"
                  fi

                  # æ‰“åŒ… v-connect-im / Package v-connect-im
                  if [ "${{ github.event.inputs.component }}" = "all" ] || [ "${{ github.event.inputs.component }}" = "v-connect-im" ]; then
                    if [ -f "$BIN_PATH/v-connect-im" ]; then
                      mkdir -p "$OUTPUT_DIR/v-connect-im"
                      cp "$BIN_PATH/v-connect-im" "$OUTPUT_DIR/v-connect-im/"
                      chmod +x "$OUTPUT_DIR/v-connect-im/v-connect-im"
                      
                      cd dist
                      tar -czf "v-connect-im-manual-${{ matrix.os }}-${{ matrix.arch }}.tar.gz" "manual-build-${{ matrix.os }}-${{ matrix.arch }}/v-connect-im"
                      cd ..
                    fi
                  fi

                  # æ‰“åŒ…æ’ä»¶ / Package plugins
                  if [ "${{ github.event.inputs.component }}" = "all" ] || [ "${{ github.event.inputs.component }}" = "plugins" ]; then
                    mkdir -p "$OUTPUT_DIR/plugins"
                    
                    if [ -f "$BIN_PATH/v-connect-im-plugin-storage-sled" ]; then
                      cp "$BIN_PATH/v-connect-im-plugin-storage-sled" "$OUTPUT_DIR/plugins/"
                      chmod +x "$OUTPUT_DIR/plugins/v-connect-im-plugin-storage-sled"
                    fi
                    
                    if [ -f "$BIN_PATH/v-connect-im-plugin-gateway" ]; then
                      cp "$BIN_PATH/v-connect-im-plugin-gateway" "$OUTPUT_DIR/plugins/"
                      chmod +x "$OUTPUT_DIR/plugins/v-connect-im-plugin-gateway"
                    fi
                    
                    cd dist
                    tar -czf "plugins-manual-${{ matrix.os }}-${{ matrix.arch }}.tar.gz" "manual-build-${{ matrix.os }}-${{ matrix.arch }}/plugins"
                    cd ..
                  fi

            - name: ä¸Šä¼ æž„å»ºäº§ç‰© / Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: manual-build-${{ matrix.os }}-${{ matrix.arch }}
                  path: dist/*.tar.gz
                  retention-days: 7

    create-release:
        name: åˆ›å»ºå‘å¸ƒ / Create Release
        needs: build
        if: github.event.inputs.create_release == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: æ£€å‡ºä»£ç  / Checkout code
              uses: actions/checkout@v4

            - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰© / Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: æ•´ç†å‘å¸ƒæ–‡ä»¶ / Organize release files
              run: |
                  mkdir -p release
                  find artifacts -type f -name "*.tar.gz" -exec cp {} release/ \;
                  ls -lh release/

            - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž / Generate release notes
              id: release_notes
              run: |
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  VERSION="manual-build-$TIMESTAMP"

                  cat > release_notes.md << EOF
                  # Manual Build $TIMESTAMP

                  ## æž„å»ºä¿¡æ¯ / Build Information

                  - **æž„å»ºæ—¶é—´ / Build Time**: $(date '+%Y-%m-%d %H:%M:%S UTC')
                  - **æž„å»ºç±»åž‹ / Build Type**: ${{ github.event.inputs.build_type }}
                  - **æž„å»ºç»„ä»¶ / Components**: ${{ github.event.inputs.component }}
                  - **ç›®æ ‡å¹³å° / Platforms**: ${{ github.event.inputs.platform }}
                  - **Git Commit**: ${{ github.sha }}

                  ## è¯´æ˜Ž / Notes

                  è¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨è§¦å‘çš„æž„å»ºï¼Œç”¨äºŽæµ‹è¯•æˆ–ç‰¹æ®Šç”¨é€”ã€‚
                  This is a manually triggered build for testing or special purposes.

                  ## ä½¿ç”¨æ–¹æ³• / Usage

                  1. ä¸‹è½½å¯¹åº”å¹³å°çš„ tar.gz æ–‡ä»¶
                  2. è§£åŽ‹: \`tar -xzf <filename>.tar.gz\`
                  3. è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶

                  EOF

                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: åˆ›å»º GitHub Release / Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.release_notes.outputs.version }}
                  name: Manual Build ${{ steps.release_notes.outputs.version }}
                  body_path: release_notes.md
                  draft: true
                  prerelease: true
                  files: release/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    summary:
        name: æž„å»ºæ‘˜è¦ / Build Summary
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: ç”Ÿæˆæ‘˜è¦ / Generate summary
              run: |
                  echo "## ðŸŽ‰ æ‰‹åŠ¨æž„å»ºå®Œæˆ / Manual Build Completed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### æž„å»ºå‚æ•° / Build Parameters" >> $GITHUB_STEP_SUMMARY
                  echo "- **ç»„ä»¶ / Component**: ${{ github.event.inputs.component }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **å¹³å° / Platform**: ${{ github.event.inputs.platform }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **ç±»åž‹ / Type**: ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **åˆ›å»ºå‘å¸ƒ / Create Release**: ${{ github.event.inputs.create_release }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ä¸‹ä¸€æ­¥ / Next Steps" >> $GITHUB_STEP_SUMMARY
                  echo "1. åœ¨ Actions é¡µé¢ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
                  echo "2. è§£åŽ‹å¹¶æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ github.event.inputs.create_release }}" = "true" ]; then
                    echo "3. æŸ¥çœ‹å¹¶å‘å¸ƒ Draft Release" >> $GITHUB_STEP_SUMMARY
                  fi
