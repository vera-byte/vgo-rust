# Taskfile for vgo-rust project
# é¡¹ç›®ä»»åŠ¡ç®¡ç†æ–‡ä»¶ / Project task management file
#
# å®‰è£… Task: https://taskfile.dev/installation/
# Install Task: brew install go-task/tap/go-task
#
# ä½¿ç”¨æ–¹æ³• / Usage:
#   task --list              # åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡ / List all tasks
#   task build:plugins       # æ„å»ºæ‰€æœ‰æ’ä»¶ / Build all plugins
#   task build:release       # æ„å»ºç”Ÿäº§ç‰ˆæœ¬ / Build release version
#   task check:plugins       # æ£€æŸ¥æ’ä»¶çŠ¶æ€ / Check plugin status
#   task cleanup:plugins     # æ¸…ç†æ’ä»¶ / Cleanup plugins

version: "3"

vars:
  PROJECT_ROOT:
    sh: pwd
  SCRIPTS_DIR: "{{.PROJECT_ROOT}}/scripts"
  DIST_DIR: "{{.PROJECT_ROOT}}/dist"
  PLUGINS_DIR: "{{.PROJECT_ROOT}}/v-plugins-hub"

tasks:
  # ============================================
  # é»˜è®¤ä»»åŠ¡ / Default Task
  # ============================================
  default:
    desc: æ˜¾ç¤ºå¯ç”¨ä»»åŠ¡åˆ—è¡¨ / Show available tasks
    cmds:
      - task --list
    silent: true

  # ============================================
  # æ„å»ºä»»åŠ¡ / Build Tasks
  # ============================================
  build:plugins:
    desc: æ„å»ºæ‰€æœ‰æ’ä»¶ä¸º .vp æ–‡ä»¶ / Build all plugins as .vp files
    summary: |
      æ„å»ºæ‰€æœ‰æ’ä»¶å¹¶æ‰“åŒ…ä¸º .vp æ–‡ä»¶
      Build all plugins and package as .vp files

      è¾“å‡ºç›®å½• / Output: {{.DIST_DIR}}/plugins
    cmds:
      - bash {{.SCRIPTS_DIR}}/build-plugins.sh
    sources:
      - "{{.PLUGINS_DIR}}/**/src/**/*.rs"
      - "{{.PLUGINS_DIR}}/**/Cargo.toml"
    generates:
      - "{{.DIST_DIR}}/plugins/*.vp"

  build:plugin:
    desc: æ„å»ºæŒ‡å®šæ’ä»¶ / Build specific plugin
    summary: |
      æ„å»ºæŒ‡å®šçš„æ’ä»¶
      Build a specific plugin

      ç”¨æ³• / Usage: task build:plugin PLUGIN=v-connect-im-plugin-storage-sled
    cmds:
      - bash {{.SCRIPTS_DIR}}/build-plugins.sh {{.PLUGIN}}
    requires:
      vars: [PLUGIN]

  build:release:
    desc: æ„å»º v-connect-im ç”Ÿäº§ç‰ˆæœ¬ / Build v-connect-im release version
    summary: |
      æ„å»º v-connect-im çš„ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬
      Build production version of v-connect-im

      è¾“å‡ºç›®å½• / Output: {{.DIST_DIR}}/v-connect-im
    cmds:
      - bash {{.SCRIPTS_DIR}}/build-release.sh
    sources:
      - "v-connect-im/src/**/*.rs"
      - "v-connect-im/Cargo.toml"
      - "v/src/**/*.rs"
    generates:
      - "{{.DIST_DIR}}/v-connect-im/bin/v-connect-im"

  build:release:custom:
    desc: æ„å»ºåˆ°è‡ªå®šä¹‰ç›®å½• / Build to custom directory
    summary: |
      æ„å»º v-connect-im åˆ°è‡ªå®šä¹‰è¾“å‡ºç›®å½•
      Build v-connect-im to custom output directory

      ç”¨æ³• / Usage: task build:release:custom OUTPUT=~/deploy/v-connect-im
    cmds:
      - bash {{.SCRIPTS_DIR}}/build-release.sh {{.OUTPUT}}
    requires:
      vars: [OUTPUT]

  build:all:
    desc: æ„å»ºæ‰€æœ‰é¡¹ç›®ï¼ˆæ’ä»¶ + ä¸»ç¨‹åºï¼‰/ Build all projects (plugins + main)
    summary: |
      æ„å»ºæ‰€æœ‰æ’ä»¶å’Œä¸»ç¨‹åº
      Build all plugins and main program
    cmds:
      - task: build:plugins
      - task: build:release

  # ============================================
  # æ£€æŸ¥å’ŒéªŒè¯ä»»åŠ¡ / Check and Validation Tasks
  # ============================================
  check:plugins:
    desc: æ£€æŸ¥æ’ä»¶çŠ¶æ€ / Check plugin status
    summary: |
      æ£€æŸ¥æ’ä»¶è¿›ç¨‹ã€socket æ–‡ä»¶ã€é…ç½®ç­‰çŠ¶æ€
      Check plugin processes, socket files, configurations, etc.
    cmds:
      - bash {{.SCRIPTS_DIR}}/check-plugins.sh

  check:workflows:
    desc: éªŒè¯ GitHub Actions å·¥ä½œæµ / Validate GitHub Actions workflows
    summary: |
      éªŒè¯ GitHub Actions å·¥ä½œæµé…ç½®
      Validate GitHub Actions workflow configurations
    cmds:
      - bash {{.SCRIPTS_DIR}}/validate-workflows.sh

  # ============================================
  # æ¸…ç†ä»»åŠ¡ / Cleanup Tasks
  # ============================================
  cleanup:plugins:
    desc: æ¸…ç†æ‰€æœ‰æ’ä»¶è¿›ç¨‹å’Œ socket æ–‡ä»¶ / Cleanup all plugin processes and socket files
    summary: |
      åœæ­¢æ‰€æœ‰æ’ä»¶è¿›ç¨‹å¹¶æ¸…ç† socket æ–‡ä»¶
      Stop all plugin processes and cleanup socket files
    cmds:
      - bash {{.SCRIPTS_DIR}}/cleanup-plugins.sh

  cleanup:dist:
    desc: æ¸…ç†æ„å»ºäº§ç‰© / Cleanup build artifacts
    summary: |
      æ¸…ç† dist ç›®å½•ä¸‹çš„æ‰€æœ‰æ„å»ºäº§ç‰©
      Cleanup all build artifacts in dist directory
    cmds:
      - rm -rf {{.DIST_DIR}}
      - echo "âœ… å·²æ¸…ç†æ„å»ºäº§ç‰© / Build artifacts cleaned"

  cleanup:target:
    desc: æ¸…ç† Cargo æ„å»ºç¼“å­˜ / Cleanup Cargo build cache
    summary: |
      æ¸…ç†æ‰€æœ‰ target ç›®å½•
      Cleanup all target directories
    cmds:
      - cargo clean
      - echo "âœ… å·²æ¸…ç† Cargo ç¼“å­˜ / Cargo cache cleaned"

  cleanup:all:
    desc: æ¸…ç†æ‰€æœ‰ï¼ˆè¿›ç¨‹ + æ„å»ºäº§ç‰© + ç¼“å­˜ï¼‰/ Cleanup all (processes + artifacts + cache)
    summary: |
      æ‰§è¡Œå®Œæ•´æ¸…ç†ï¼šåœæ­¢è¿›ç¨‹ã€åˆ é™¤æ„å»ºäº§ç‰©å’Œç¼“å­˜
      Full cleanup: stop processes, remove artifacts and cache
    cmds:
      - task: cleanup:plugins
      - task: cleanup:dist
      - task: cleanup:target

  # ============================================
  # å¼€å‘ä»»åŠ¡ / Development Tasks
  # ============================================
  dev:im:
    desc: å¯åŠ¨ v-connect-im å¼€å‘æœåŠ¡å™¨ / Start v-connect-im dev server
    summary: |
      åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨ v-connect-im
      Start v-connect-im in development mode
    dir: v-connect-im
    cmds:
      - cargo run

  dev:admin:
    desc: å¯åŠ¨ v-admin å¼€å‘æœåŠ¡å™¨ / Start v-admin dev server
    summary: |
      åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨ v-admin
      Start v-admin in development mode
    dir: v-admin
    cmds:
      - cargo run

  dev:auth:
    desc: å¯åŠ¨ v-auth-center å¼€å‘æœåŠ¡å™¨ / Start v-auth-center dev server
    summary: |
      åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨ v-auth-center
      Start v-auth-center in development mode
    dir: v-auth-center
    cmds:
      - cargo run

  # ============================================
  # æµ‹è¯•ä»»åŠ¡ / Test Tasks
  # ============================================
  test:
    desc: è¿è¡Œæ‰€æœ‰æµ‹è¯• / Run all tests
    summary: |
      è¿è¡Œå·¥ä½œåŒºä¸­çš„æ‰€æœ‰æµ‹è¯•
      Run all tests in workspace
    cmds:
      - cargo test --workspace

  test:v:
    desc: æµ‹è¯•å…¬å…±åº“ v / Test common library v
    summary: |
      è¿è¡Œ v åº“çš„æµ‹è¯•
      Run tests for v library
    dir: v
    cmds:
      - cargo test

  test:im:
    desc: æµ‹è¯• v-connect-im / Test v-connect-im
    summary: |
      è¿è¡Œ v-connect-im çš„æµ‹è¯•
      Run tests for v-connect-im
    dir: v-connect-im
    cmds:
      - cargo test

  # ============================================
  # ä»£ç è´¨é‡ä»»åŠ¡ / Code Quality Tasks
  # ============================================
  fmt:
    desc: æ ¼å¼åŒ–ä»£ç  / Format code
    summary: |
      ä½¿ç”¨ rustfmt æ ¼å¼åŒ–æ‰€æœ‰ Rust ä»£ç 
      Format all Rust code using rustfmt
    cmds:
      - cargo fmt --all

  fmt:check:
    desc: æ£€æŸ¥ä»£ç æ ¼å¼ / Check code format
    summary: |
      æ£€æŸ¥ä»£ç æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒï¼ˆä¸ä¿®æ”¹æ–‡ä»¶ï¼‰
      Check if code format is correct (without modifying files)
    cmds:
      - cargo fmt --all -- --check

  clippy:
    desc: è¿è¡Œ Clippy ä»£ç æ£€æŸ¥ / Run Clippy linter
    summary: |
      ä½¿ç”¨ Clippy æ£€æŸ¥ä»£ç è´¨é‡
      Check code quality using Clippy
    cmds:
      - cargo clippy --workspace --all-targets -- -D warnings

  lint:
    desc: è¿è¡Œæ‰€æœ‰ä»£ç æ£€æŸ¥ / Run all linters
    summary: |
      è¿è¡Œæ ¼å¼æ£€æŸ¥å’Œ Clippy
      Run format check and Clippy
    cmds:
      - task: fmt:check
      - task: clippy

  # ============================================
  # æ–‡æ¡£ä»»åŠ¡ / Documentation Tasks
  # ============================================
  docs:build:
    desc: æ„å»º Rust æ–‡æ¡£ / Build Rust documentation
    summary: |
      ç”Ÿæˆ Rust API æ–‡æ¡£
      Generate Rust API documentation
    cmds:
      - cargo doc --workspace --no-deps

  docs:open:
    desc: æ‰“å¼€ Rust æ–‡æ¡£ / Open Rust documentation
    summary: |
      ç”Ÿæˆå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ Rust API æ–‡æ¡£
      Generate and open Rust API documentation in browser
    cmds:
      - cargo doc --workspace --no-deps --open

  docs:serve:
    desc: å¯åŠ¨ Mintlify æ–‡æ¡£æœåŠ¡å™¨ / Start Mintlify docs server
    summary: |
      å¯åŠ¨é¡¹ç›®æ–‡æ¡£å¼€å‘æœåŠ¡å™¨
      Start project documentation dev server
    dir: docs
    cmds:
      - mintlify dev

  # ============================================
  # æ•°æ®åº“ä»»åŠ¡ / Database Tasks
  # ============================================
  db:migrate:
    desc: è¿è¡Œæ•°æ®åº“è¿ç§» / Run database migrations
    summary: |
      æ‰§è¡Œ SQL è¿ç§»è„šæœ¬
      Execute SQL migration scripts
    cmds:
      - echo "âš ï¸  è¯·æ‰‹åŠ¨æ‰§è¡Œ sql/ ç›®å½•ä¸‹çš„è¿ç§»è„šæœ¬"
      - echo "âš ï¸  Please manually execute migration scripts in sql/ directory"

  # ============================================
  # å·¥å…·ä»»åŠ¡ / Utility Tasks
  # ============================================
  install:tools:
    desc: å®‰è£…å¼€å‘å·¥å…· / Install development tools
    summary: |
      å®‰è£…é¡¹ç›®æ‰€éœ€çš„å¼€å‘å·¥å…·
      Install required development tools
    cmds:
      - rustup component add rustfmt clippy
      - cargo install cargo-watch
      - echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆ / Development tools installed"

  watch:im:
    desc: ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶é‡å¯ v-connect-im / Watch and restart v-connect-im
    summary: |
      ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œè¿è¡Œ v-connect-im
      Watch for file changes and auto-recompile v-connect-im

      éœ€è¦å…ˆå®‰è£…: cargo install cargo-watch
    dir: v-connect-im
    cmds:
      - cargo watch -x run

  # ============================================
  # ä¿¡æ¯ä»»åŠ¡ / Info Tasks
  # ============================================
  info:
    desc: æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯ / Show project information
    summary: |
      æ˜¾ç¤ºé¡¹ç›®ç»“æ„å’Œé…ç½®ä¿¡æ¯
      Show project structure and configuration info
    cmds:
      - 'echo "ğŸ“¦ é¡¹ç›®æ ¹ç›®å½• / Project Root: {{.PROJECT_ROOT}}"'
      - 'echo "ğŸ“ è„šæœ¬ç›®å½• / Scripts Dir: {{.SCRIPTS_DIR}}"'
      - 'echo "ğŸ“ è¾“å‡ºç›®å½• / Output Dir: {{.DIST_DIR}}"'
      - 'echo "ğŸ“ æ’ä»¶ç›®å½• / Plugins Dir: {{.PLUGINS_DIR}}"'
      - echo ""
      - 'echo "ğŸ”§ å¯ç”¨ä»»åŠ¡ / Available Tasks:"'
      - task --list

  version:
    desc: æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ / Show version information
    summary: |
      æ˜¾ç¤ºå„ä¸ªç»„ä»¶çš„ç‰ˆæœ¬ä¿¡æ¯
      Show version information for all components
    cmds:
      - echo "v-connect-im:"
      - grep '^version' v-connect-im/Cargo.toml | head -1
      - echo ""
      - echo "v-admin:"
      - grep '^version' v-admin/Cargo.toml | head -1
      - echo ""
      - echo "v-auth-center:"
      - grep '^version' v-auth-center/Cargo.toml | head -1
      - echo ""
      - echo "v (common library):"
      - grep '^version' v/Cargo.toml | head -1
